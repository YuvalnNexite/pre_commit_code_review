<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Auto Code Review Viewer</title>
    <script>
      tailwind = {
        config: {
          darkMode: 'class',
          theme: {
            extend: {
              colors: {
                brand: {
                  50: '#eef2ff',
                  500: '#4f46e5',
                  600: '#4338ca'
                }
              },
              boxShadow: {
                header: '0 10px 25px -20px rgba(15, 23, 42, 0.7)'
              }
            }
          }
        }
      };
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link
      id="hljs-light"
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
      integrity="sha512-f3fUy6oyboTfp9khSdJj0dk8Z6kOKeZBT5Zzm4jcbmUFzmIum10lANphHz2Xee3RG6Nnz33rgxmzkqOovu0QcQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      id="hljs-dark"
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
      integrity="sha512-Qcj2tjhL1k4UJgSMuY1OJQrY1hi83CrQn+E21c/Q5v4VXtCaw2V4ckQkZOdhZlJq0pWjTB57TUzRAFGa5Nft6g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
      disabled
    />
    <style>
      :root {
        --acr-font-size: 0.875rem;
        --acr-line-height: 1.65;
      }

      body {
        font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
      }
      pre code {
        font-family: 'JetBrains Mono', 'Fira Code', 'SFMono-Regular', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      }
      pre {
        border-radius: 0.75rem;
      }
      .prose pre {
        padding: 1rem;
      }
      .prose code {
        border-radius: 0.375rem;
      }
      .acr-content {
        font-size: var(--acr-font-size);
        line-height: var(--acr-line-height);
      }
      .acr-content :where(p, li, blockquote, dd) {
        line-height: var(--acr-line-height);
      }
      .prose :where(code):not(:where([class~="not-prose"] *)) {
        background-color: rgba(15, 23, 42, 0.05);
        padding: 0.125rem 0.375rem;
      }
      html.dark .prose :where(code):not(:where([class~="not-prose"] *)) {
        background-color: rgba(148, 163, 184, 0.12);
      }
      html.dark body {
        background-color: #0f172a;
      }
      pre code.language-diff {
        display: block;
        padding: 0;
      }
      .diff-line {
        display: block;
        white-space: pre;
        margin: 0 -1rem;
        padding: 0.125rem 1rem;
        border-radius: 0;
      }
      .diff-line:first-child {
        border-top-left-radius: 0.75rem;
        border-top-right-radius: 0.75rem;
      }
      .diff-line:last-child {
        border-bottom-left-radius: 0.75rem;
        border-bottom-right-radius: 0.75rem;
      }
      .diff-context {
        color: inherit;
      }
      .diff-meta {
        background-color: rgba(148, 163, 184, 0.18);
        color: #334155;
        font-weight: 500;
      }
      .diff-hunk {
        background-color: rgba(59, 130, 246, 0.14);
        color: #1d4ed8;
        font-weight: 600;
      }
      .diff-add {
        background-color: rgba(34, 197, 94, 0.18);
        color: #166534;
      }
      .diff-remove {
        background-color: rgba(248, 113, 113, 0.18);
        color: #7f1d1d;
      }
      html.dark .diff-meta {
        background-color: rgba(148, 163, 184, 0.14);
        color: #cbd5f5;
      }
      html.dark .diff-hunk {
        background-color: rgba(59, 130, 246, 0.24);
        color: #bfdbfe;
      }
      html.dark .diff-add {
        background-color: rgba(34, 197, 94, 0.22);
        color: #bbf7d0;
      }
      html.dark .diff-remove {
        background-color: rgba(248, 113, 113, 0.24);
        color: #fecaca;
      }
    </style>
  </head>
  <body class="min-h-full bg-slate-100 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
    <div class="flex min-h-screen flex-col">
      <header class="sticky top-0 z-20 border-b border-slate-200/70 bg-white/80 backdrop-blur dark:border-slate-800/60 dark:bg-slate-950/80">
        <div class="mx-auto flex w-full max-w-6xl items-center justify-between gap-4 px-4 py-3 sm:px-6">
          <div class="flex-1 text-left text-base font-semibold tracking-tight sm:text-lg">
            Auto Code Review Viewer
          </div>
          <div class="hidden flex-1 overflow-hidden text-center text-xs font-medium text-slate-500 dark:text-slate-400 sm:block sm:text-sm">
            Viewing <span class="font-semibold text-slate-700 dark:text-slate-200">{{FILE_NAME}}</span> from
            <span class="truncate text-slate-500 dark:text-slate-400">{{FILE_PATH}}</span>
          </div>
          <div class="flex flex-1 items-center justify-end gap-3">
            <div class="relative">
              <button
                id="settings-toggle"
                type="button"
                aria-haspopup="true"
                aria-expanded="false"
                class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:border-slate-300 hover:text-slate-900 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:border-slate-600 dark:hover:text-white"
              >
                <span aria-hidden="true">‚öôÔ∏è</span>
                <span>Settings</span>
              </button>
              <div
                id="settings-panel"
                class="absolute right-0 z-30 mt-2 w-64 rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-700 shadow-lg ring-1 ring-black/5 transition dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:ring-white/10"
                hidden
              >
                <div class="flex flex-col gap-4">
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <label for="font-size-select" class="block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Font size</label>
                      <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Adjust the base font size of the review.</p>
                    </div>
                    <select
                      id="font-size-select"
                      class="rounded-lg border border-slate-200 bg-white px-2 py-1 text-sm font-medium text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100"
                    >
                      <option value="sm">Small</option>
                      <option value="md">Medium</option>
                      <option value="lg">Large</option>
                    </select>
                  </div>
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <label for="line-spacing-select" class="block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Line spacing</label>
                      <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Control the spacing between lines.</p>
                    </div>
                    <select
                      id="line-spacing-select"
                      class="rounded-lg border border-slate-200 bg-white px-2 py-1 text-sm font-medium text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100"
                    >
                      <option value="compact">Compact</option>
                      <option value="cozy">Cozy</option>
                      <option value="relaxed">Relaxed</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <button
              id="theme-toggle"
              type="button"
              class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:border-slate-300 hover:text-slate-900 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:border-slate-600 dark:hover:text-white"
            >
              <span aria-hidden="true" id="theme-toggle-icon">üåô</span>
              <span id="theme-toggle-label">Dark mode</span>
            </button>
          </div>
        </div>
        <div class="block border-t border-slate-200/70 px-4 py-2 text-xs text-slate-500 dark:border-slate-800/60 dark:text-slate-400 sm:hidden">
          Viewing <span class="font-semibold text-slate-700 dark:text-slate-200">{{FILE_NAME}}</span>
          <div class="truncate overflow-hidden text-[11px] text-slate-500 dark:text-slate-400">{{FILE_PATH}}</div>
        </div>
      </header>
      <main class="flex-1">
        <div class="mx-auto w-full max-w-6xl px-4 pb-12 pt-6 sm:px-6">
          <div class="mb-6 flex flex-wrap items-center justify-between gap-3">
            <div
              class="inline-flex rounded-full border border-slate-200 bg-white p-1 text-sm font-medium shadow-sm dark:border-slate-700 dark:bg-slate-900"
              role="group"
              aria-label="Viewer mode"
            >
              <button
                id="mode-report"
                type="button"
                data-viewer-mode="report"
                class="mode-toggle-button inline-flex items-center gap-2 rounded-full px-4 py-1.5 text-sm font-semibold transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-500"
              >
                <span>Report</span>
              </button>
              <button
                id="mode-action"
                type="button"
                data-viewer-mode="action"
                class="mode-toggle-button inline-flex items-center gap-2 rounded-full px-4 py-1.5 text-sm font-semibold transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-500"
              >
                <span>Action</span>
              </button>
            </div>
            <div class="text-xs text-slate-500 dark:text-slate-400">
              Use Action mode to apply suggestions. Hotkeys activate while Action mode is open.
            </div>
          </div>
          <section id="report-view">
            <article
              class="acr-content prose-sm prose-slate max-w-none dark:prose-invert"
              style="font-size: var(--acr-font-size); line-height: var(--acr-line-height);"
            >
              {{CONTENT}}
            </article>
          </section>
          <section id="action-view" class="space-y-6" hidden>
            <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
              <div class="flex flex-wrap items-start justify-between gap-4">
                <div>
                  <h2 class="text-lg font-semibold text-slate-800 dark:text-slate-100">Action mode</h2>
                  <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
                    Step through each bad assessment and apply its suggested diff.
                  </p>
                </div>
                <div class="flex items-center gap-2">
                  <button
                    id="action-help-button"
                    type="button"
                    class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-3 py-1.5 text-sm font-medium text-slate-600 transition hover:border-slate-300 hover:bg-white focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-500 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:border-slate-600 dark:hover:bg-slate-700"
                  >
                    <span>Help</span>
                    <span class="rounded-full bg-slate-200 px-1.5 py-0.5 text-xs font-semibold text-slate-700 dark:bg-slate-700 dark:text-slate-200">?</span>
                  </button>
                </div>
              </div>
              <div id="action-count" class="mt-3 text-xs text-slate-500 dark:text-slate-400"></div>
            </div>
            <div id="action-feedback" class="hidden rounded-2xl border px-4 py-3 text-sm"></div>
            <div
              id="action-empty"
              class="rounded-2xl border border-dashed border-slate-300 bg-white/60 p-8 text-center text-sm text-slate-500 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-300"
            >
              Loading bad assessments‚Ä¶
            </div>
            <div id="action-body" class="space-y-5" hidden>
              <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <div id="action-progress" class="text-sm font-semibold text-slate-700 dark:text-slate-200"></div>
                  <div id="action-status-summary" class="text-xs text-slate-500 dark:text-slate-400"></div>
                </div>
                <div id="action-status-list" class="mt-3 flex flex-wrap gap-2"></div>
              </div>
              <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
                <div class="flex flex-col gap-4">
                  <div>
                    <h3 id="action-title" class="text-xl font-semibold text-slate-800 dark:text-slate-100"></h3>
                    <div class="mt-2 flex flex-wrap gap-2 text-xs font-medium">
                      <span
                        id="action-file"
                        class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 text-slate-600 dark:bg-slate-800 dark:text-slate-200"
                      ></span>
                      <span
                        id="action-lines"
                        class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 text-slate-600 dark:bg-slate-800 dark:text-slate-200"
                      ></span>
                      <span
                        id="action-function"
                        class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 text-slate-600 dark:bg-slate-800 dark:text-slate-200"
                      ></span>
                    </div>
                  </div>
                  <div class="space-y-4 text-sm leading-relaxed text-slate-700 dark:text-slate-200">
                    <div>
                      <h4 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Details</h4>
                      <p id="action-details" class="mt-1 whitespace-pre-wrap"></p>
                    </div>
                    <div>
                      <h4 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Suggestion</h4>
                      <p id="action-suggestion-text" class="mt-1 whitespace-pre-wrap"></p>
                      <div
                        id="action-diff"
                        class="mt-3 hidden overflow-hidden rounded-xl border border-slate-200 dark:border-slate-700"
                      ></div>
                    </div>
                    <div>
                      <h4 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Reasoning</h4>
                      <p id="action-reasoning" class="mt-1 whitespace-pre-wrap"></p>
                    </div>
                  </div>
                </div>
                <div class="mt-5 flex flex-wrap items-center justify-between gap-3">
                  <div class="flex flex-wrap gap-2">
                    <button
                      id="action-prev"
                      type="button"
                      class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:bg-slate-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-500 disabled:cursor-not-allowed disabled:opacity-60 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:border-slate-600 dark:hover:bg-slate-700"
                    >
                      ‚óÄ Previous (P)
                    </button>
                    <button
                      id="action-next"
                      type="button"
                      class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:bg-slate-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-500 disabled:cursor-not-allowed disabled:opacity-60 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:border-slate-600 dark:hover:bg-slate-700"
                    >
                      Next (N) ‚ñ∂
                    </button>
                  </div>
                  <div class="flex flex-wrap gap-2">
                    <button
                      id="action-apply"
                      type="button"
                      class="inline-flex items-center gap-2 rounded-full border border-emerald-500 bg-emerald-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-emerald-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-500 disabled:cursor-not-allowed disabled:opacity-60"
                    >
                      Apply (A)
                    </button>
                    <button
                      id="action-skip"
                      type="button"
                      class="inline-flex items-center gap-2 rounded-full border border-amber-400 bg-amber-100 px-4 py-2 text-sm font-semibold text-amber-700 transition hover:bg-amber-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-500 disabled:cursor-not-allowed disabled:opacity-60 dark:border-amber-500 dark:bg-amber-500/20 dark:text-amber-200"
                    >
                      Skip (S)
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div
              id="action-help-panel"
              class="hidden rounded-2xl border border-slate-200 bg-white p-5 text-sm shadow-xl focus:outline-none dark:border-slate-800 dark:bg-slate-900"
              tabindex="-1"
              role="dialog"
              aria-modal="false"
            >
              <div class="flex items-center justify-between gap-3">
                <h3 class="text-base font-semibold text-slate-800 dark:text-slate-100">Keyboard shortcuts</h3>
                <button
                  id="action-help-close"
                  type="button"
                  class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-slate-300 hover:bg-slate-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-500 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:border-slate-600 dark:hover:bg-slate-700"
                >
                  Close
                </button>
              </div>
              <ul class="mt-4 space-y-2 text-slate-600 dark:text-slate-300">
                <li><span class="font-semibold">N</span> ‚Äì Next assessment</li>
                <li><span class="font-semibold">P</span> ‚Äì Previous assessment</li>
                <li><span class="font-semibold">A</span> ‚Äì Apply suggestion</li>
                <li><span class="font-semibold">S</span> ‚Äì Skip assessment</li>
                <li><span class="font-semibold">?</span> ‚Äì Toggle this help</li>
              </ul>
              <p class="mt-4 text-xs text-slate-500 dark:text-slate-400">
                Actions update the status list above so you can see what has been applied or skipped.
              </p>
            </div>
          </section>
        </div>
      </main>
      <footer class="border-t border-slate-200/70 bg-white/70 py-3 text-sm text-slate-500 backdrop-blur dark:border-slate-800/60 dark:bg-slate-950/70 dark:text-slate-400">
        <div class="mx-auto flex w-full max-w-6xl items-center justify-between px-4 sm:px-6">
          <span id="status-line" class="text-slate-500 dark:text-slate-400">Watching for changes‚Ä¶</span>
          <span class="hidden text-xs sm:block">Auto-refresh enabled</span>
        </div>
      </footer>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-b8qFkC4bIZfv5Ih0b07XHkTTwxabycufV7g9cMPed+0YLsFd1oS29Jym+wIpLW6+BFmGoG9PMa2wiuVdbTNjlQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/diff.min.js" integrity="sha512-f9GtPgNj0JfnYuxzsDgVKfd3RewZF8nPULz/0NkGi/Sd35rEJMMHSdOQcgynb43S/G/Sq0yYMpnt/kFBTw+Fxg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
      const themeToggle = document.getElementById('theme-toggle');
      const statusLine = document.getElementById('status-line');
      const themeToggleLabel = document.getElementById('theme-toggle-label');
      const themeToggleIcon = document.getElementById('theme-toggle-icon');
      const hljsLight = document.getElementById('hljs-light');
      const hljsDark = document.getElementById('hljs-dark');
      const settingsToggle = document.getElementById('settings-toggle');
      const settingsPanel = document.getElementById('settings-panel');
      const fontSizeSelect = document.getElementById('font-size-select');
      const lineSpacingSelect = document.getElementById('line-spacing-select');
      const reportView = document.getElementById('report-view');
      const actionView = document.getElementById('action-view');
      const actionBody = document.getElementById('action-body');
      const actionEmpty = document.getElementById('action-empty');
      const actionFeedback = document.getElementById('action-feedback');
      const actionProgress = document.getElementById('action-progress');
      const actionStatusList = document.getElementById('action-status-list');
      const actionStatusSummary = document.getElementById('action-status-summary');
      const actionTitle = document.getElementById('action-title');
      const actionFile = document.getElementById('action-file');
      const actionLines = document.getElementById('action-lines');
      const actionFunction = document.getElementById('action-function');
      const actionDetails = document.getElementById('action-details');
      const actionSuggestionText = document.getElementById('action-suggestion-text');
      const actionReasoning = document.getElementById('action-reasoning');
      const actionDiffContainer = document.getElementById('action-diff');
      const actionCountLabel = document.getElementById('action-count');
      const actionPrevButton = document.getElementById('action-prev');
      const actionNextButton = document.getElementById('action-next');
      const actionApplyButton = document.getElementById('action-apply');
      const actionSkipButton = document.getElementById('action-skip');
      const actionHelpButton = document.getElementById('action-help-button');
      const actionHelpPanel = document.getElementById('action-help-panel');
      const actionHelpClose = document.getElementById('action-help-close');
      const modeToggleButtons = document.querySelectorAll('[data-viewer-mode]');

      const FONT_SIZE_OPTIONS = {
        sm: '0.875rem',
        md: '1rem',
        lg: '1.125rem'
      };

      const LINE_SPACING_OPTIONS = {
        compact: '1.5',
        cozy: '1.65',
        relaxed: '1.8'
      };

      const DEFAULT_READING_PREFS = {
        fontSize: 'sm',
        lineSpacing: 'cozy'
      };

      const MODE_STORAGE_KEY = 'acr-view-mode';
      const MODE_BUTTON_ACTIVE_CLASSES = ['bg-brand-500', 'text-white', 'shadow'];
      const MODE_BUTTON_INACTIVE_CLASSES = [
        'bg-transparent',
        'text-slate-600',
        'hover:bg-slate-100',
        'dark:text-slate-300',
        'dark:hover:bg-slate-800'
      ];
      const STATUS_CLASS_MAP = {
        pending: ['border-slate-200', 'bg-white', 'text-slate-500', 'dark:border-slate-700', 'dark:bg-slate-900', 'dark:text-slate-300'],
        applied: ['border-emerald-500', 'bg-emerald-50', 'text-emerald-700', 'dark:border-emerald-400/70', 'dark:bg-emerald-500/10', 'dark:text-emerald-200'],
        skipped: ['border-amber-500', 'bg-amber-50', 'text-amber-700', 'dark:border-amber-400/70', 'dark:bg-amber-500/10', 'dark:text-amber-200']
      };
      const STATUS_SYMBOLS = {
        pending: '',
        applied: '‚úì',
        skipped: '‚Ü∑'
      };
      const FEEDBACK_CLASS_MAP = {
        success: ['border-emerald-500', 'bg-emerald-50', 'text-emerald-700', 'dark:border-emerald-400/70', 'dark:bg-emerald-500/10', 'dark:text-emerald-200'],
        error: ['border-rose-500', 'bg-rose-50', 'text-rose-700', 'dark:border-rose-400/70', 'dark:bg-rose-500/10', 'dark:text-rose-200'],
        info: ['border-slate-300', 'bg-slate-100', 'text-slate-700', 'dark:border-slate-600', 'dark:bg-slate-800', 'dark:text-slate-200']
      };
      const ALL_FEEDBACK_CLASSES = Array.from(new Set(Object.values(FEEDBACK_CLASS_MAP).flat()));

      const actionState = {
        loading: false,
        loaded: false,
        assessments: [],
        currentIndex: 0,
        updatedAt: null
      };
      let currentViewerMode = 'report';
      let actionHelpVisible = false;
      let applyingSuggestion = false;

      function applyReadingPreferences(prefs) {
        const root = document.documentElement;
        const fontSize = FONT_SIZE_OPTIONS[prefs.fontSize] || FONT_SIZE_OPTIONS[DEFAULT_READING_PREFS.fontSize];
        const lineHeight = LINE_SPACING_OPTIONS[prefs.lineSpacing] || LINE_SPACING_OPTIONS[DEFAULT_READING_PREFS.lineSpacing];
        root.style.setProperty('--acr-font-size', fontSize);
        root.style.setProperty('--acr-line-height', lineHeight);
      }

      function loadReadingPreferences() {
        try {
          const raw = window.localStorage.getItem('acr-reading-prefs');
          if (!raw) return { ...DEFAULT_READING_PREFS };
          const parsed = JSON.parse(raw);
          if (typeof parsed !== 'object' || parsed === null) {
            return { ...DEFAULT_READING_PREFS };
          }
          return {
            fontSize: parsed.fontSize && FONT_SIZE_OPTIONS[parsed.fontSize] ? parsed.fontSize : DEFAULT_READING_PREFS.fontSize,
            lineSpacing:
              parsed.lineSpacing && LINE_SPACING_OPTIONS[parsed.lineSpacing]
                ? parsed.lineSpacing
                : DEFAULT_READING_PREFS.lineSpacing
          };
        } catch (error) {
          console.warn('Failed to load reading preferences', error);
          return { ...DEFAULT_READING_PREFS };
        }
      }

      function saveReadingPreferences(prefs) {
        try {
          window.localStorage.setItem('acr-reading-prefs', JSON.stringify(prefs));
        } catch (error) {
          console.warn('Failed to save reading preferences', error);
        }
      }

      function syncReadingControls(prefs) {
        if (fontSizeSelect) {
          fontSizeSelect.value = prefs.fontSize;
        }
        if (lineSpacingSelect) {
          lineSpacingSelect.value = prefs.lineSpacing;
        }
      }

      const readingPreferences = loadReadingPreferences();
      applyReadingPreferences(readingPreferences);
      syncReadingControls(readingPreferences);

      function updateReadingPreference(key, value) {
        const updated = { ...readingPreferences, [key]: value };
        readingPreferences.fontSize = updated.fontSize;
        readingPreferences.lineSpacing = updated.lineSpacing;
        applyReadingPreferences(updated);
        saveReadingPreferences(updated);
      }

      fontSizeSelect?.addEventListener('change', (event) => {
        const value = event.target.value;
        if (FONT_SIZE_OPTIONS[value]) {
          updateReadingPreference('fontSize', value);
        }
      });

      lineSpacingSelect?.addEventListener('change', (event) => {
        const value = event.target.value;
        if (LINE_SPACING_OPTIONS[value]) {
          updateReadingPreference('lineSpacing', value);
        }
      });

      function setSettingsPanelVisibility(visible) {
        if (!settingsPanel || !settingsToggle) return;
        if (visible) {
          settingsPanel.hidden = false;
          settingsToggle.setAttribute('aria-expanded', 'true');
        } else {
          settingsPanel.hidden = true;
          settingsToggle.setAttribute('aria-expanded', 'false');
        }
      }

      function toggleSettingsPanel() {
        if (!settingsPanel) return;
        const isHidden = settingsPanel.hasAttribute('hidden');
        setSettingsPanelVisibility(isHidden);
      }

      settingsToggle?.addEventListener('click', (event) => {
        event.stopPropagation();
        toggleSettingsPanel();
      });

      document.addEventListener('click', (event) => {
        if (!settingsPanel || settingsPanel.hasAttribute('hidden')) return;
        if (settingsPanel.contains(event.target) || settingsToggle?.contains(event.target)) {
          return;
        }
        setSettingsPanelVisibility(false);
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          setSettingsPanelVisibility(false);
          hideHelpPanel();
        }
      });

      function getStoredMode() {
        try {
          const stored = window.localStorage.getItem(MODE_STORAGE_KEY);
          if (stored === 'action' || stored === 'report') {
            return stored;
          }
        } catch (error) {
          console.warn('Failed to read viewer mode from storage', error);
        }
        return 'report';
      }

      function persistViewerMode(mode) {
        try {
          window.localStorage.setItem(MODE_STORAGE_KEY, mode);
        } catch (error) {
          console.warn('Failed to store viewer mode', error);
        }
      }

      function setActionFeedback(type, message) {
        if (!actionFeedback) {
          return;
        }
        ALL_FEEDBACK_CLASSES.forEach((cls) => actionFeedback.classList.remove(cls));
        if (!message) {
          actionFeedback.classList.add('hidden');
          actionFeedback.textContent = '';
          return;
        }
        const classes = FEEDBACK_CLASS_MAP[type] || FEEDBACK_CLASS_MAP.info;
        classes.forEach((cls) => actionFeedback.classList.add(cls));
        actionFeedback.textContent = message;
        actionFeedback.classList.remove('hidden');
      }

      function updateModeButtons(mode) {
        modeToggleButtons.forEach((button) => {
          const buttonMode = button.dataset.viewerMode === 'action' ? 'action' : 'report';
          const isActive = buttonMode === mode;
          MODE_BUTTON_ACTIVE_CLASSES.forEach((cls) => button.classList.toggle(cls, isActive));
          MODE_BUTTON_INACTIVE_CLASSES.forEach((cls) => button.classList.toggle(cls, !isActive));
          button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
      }

      function showReportView() {
        reportView?.removeAttribute('hidden');
        actionView?.setAttribute('hidden', '');
        hideHelpPanel();
      }

      function showActionView() {
        reportView?.setAttribute('hidden', '');
        actionView?.removeAttribute('hidden');
        ensureActionData();
      }

      function setViewerMode(mode, options = {}) {
        const nextMode = mode === 'action' ? 'action' : 'report';
        currentViewerMode = nextMode;
        if (!options.skipStorage) {
          persistViewerMode(nextMode);
        }
        if (nextMode === 'action') {
          showActionView();
        } else {
          showReportView();
        }
        updateModeButtons(nextMode);
      }

      function showActionEmpty(message) {
        if (actionEmpty) {
          if (typeof message === 'string') {
            actionEmpty.textContent = message;
          }
          actionEmpty.removeAttribute('hidden');
        }
        actionBody?.setAttribute('hidden', '');
      }

      function hideActionEmpty() {
        actionEmpty?.setAttribute('hidden', '');
        actionBody?.removeAttribute('hidden');
      }

      function markAssessmentStatus(index, status) {
        const target = actionState.assessments[index];
        if (!target) {
          return;
        }
        target.status = status;
        target.updatedAt = Date.now();
      }

      function updateActionSummary() {
        if (!actionStatusSummary) {
          return;
        }
        const total = actionState.assessments.length;
        if (!total) {
          actionStatusSummary.textContent = '';
          return;
        }
        let applied = 0;
        let skipped = 0;
        actionState.assessments.forEach((assessment) => {
          if (assessment.status === 'applied') {
            applied += 1;
          } else if (assessment.status === 'skipped') {
            skipped += 1;
          }
        });
        const pending = total - applied - skipped;
        actionStatusSummary.textContent = `Applied ${applied} ¬∑ Skipped ${skipped} ¬∑ Pending ${pending}`;
      }

      function renderStatusChips() {
        if (!actionStatusList) {
          return;
        }
        actionStatusList.innerHTML = '';
        actionState.assessments.forEach((assessment, index) => {
          const button = document.createElement('button');
          button.type = 'button';
          button.className =
            'inline-flex min-w-[2.5rem] items-center justify-center rounded-full border px-3 py-1 text-xs font-semibold transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-500';
          const status = assessment.status || 'pending';
          const classes = STATUS_CLASS_MAP[status] || STATUS_CLASS_MAP.pending;
          classes.forEach((cls) => button.classList.add(cls));
          if (index === actionState.currentIndex) {
            button.classList.add('ring-2', 'ring-brand-500', 'ring-offset-2', 'ring-offset-white', 'dark:ring-offset-slate-900');
          }
          const symbol = STATUS_SYMBOLS[status] || '';
          button.innerHTML = `<span class="font-semibold">${index + 1}</span>${symbol ? `<span class="ml-1 text-[11px]">${symbol}</span>` : ''}`;
          button.dataset.index = String(index);
          button.title = assessment.title ? `${assessment.title} (${status})` : `Assessment ${index + 1}`;
          button.addEventListener('click', () => {
            setCurrentIndex(index);
          });
          actionStatusList.appendChild(button);
        });
      }

      function setMetaBadge(element, prefix, value) {
        if (!element) {
          return;
        }
        if (value) {
          element.textContent = prefix ? `${prefix}${value}` : value;
          element.classList.remove('hidden');
        } else {
          element.textContent = '';
          element.classList.add('hidden');
        }
      }

      function updateActionCountLabel(total) {
        if (!actionCountLabel) {
          return;
        }
        if (!total) {
          actionCountLabel.textContent = '';
          return;
        }
        const parts = [`Loaded ${total} bad assessment${total === 1 ? '' : 's'}.`];
        if (actionState.updatedAt) {
          parts.push(`Last updated ${formatTimestamp(actionState.updatedAt)}`);
        }
        actionCountLabel.textContent = parts.join(' ');
      }

      function updateActionView() {
        if (!actionBody) {
          return;
        }
        const total = actionState.assessments.length;
        if (!total) {
          updateActionCountLabel(0);
          showActionEmpty('No bad assessments were found. Switch back to Report mode to read the full review.');
          setActionFeedback('', '');
          return;
        }
        hideActionEmpty();
        updateActionCountLabel(total);
        if (actionState.currentIndex < 0 || actionState.currentIndex >= total) {
          actionState.currentIndex = 0;
        }
        const current = actionState.assessments[actionState.currentIndex];
        if (actionProgress) {
          actionProgress.textContent = `Assessment ${actionState.currentIndex + 1} of ${total}`;
        }
        renderStatusChips();
        updateActionSummary();
        if (actionTitle) {
          actionTitle.textContent = current.title || `Assessment ${actionState.currentIndex + 1}`;
        }
        setMetaBadge(actionFile, 'üìÑ ', current.file || '');
        setMetaBadge(actionLines, 'üìå Lines ', current.lines || '');
        setMetaBadge(actionFunction, '∆í ', current.function || '');
        if (actionDetails) {
          actionDetails.textContent = current.details || 'No additional details provided.';
        }
        if (actionSuggestionText) {
          actionSuggestionText.textContent = current.suggestion?.text || 'Suggestion is provided as a diff.';
        }
        if (actionReasoning) {
          actionReasoning.textContent = current.reasoning || 'No reasoning supplied.';
        }
        if (actionDiffContainer) {
          actionDiffContainer.innerHTML = '';
          actionDiffContainer.classList.add('hidden');
          if (current.suggestion && current.suggestion.diff) {
            const pre = document.createElement('pre');
            const code = document.createElement('code');
            code.className = 'language-diff';
            const diffText = current.suggestion.diff.endsWith('\n')
              ? current.suggestion.diff
              : `${current.suggestion.diff}\n`;
            code.textContent = diffText;
            pre.appendChild(code);
            actionDiffContainer.appendChild(pre);
            actionDiffContainer.classList.remove('hidden');
            try {
              if (window.hljs?.highlightElement) {
                window.hljs.highlightElement(code);
              }
            } catch (error) {
              console.warn('Failed to highlight diff', error);
            }
            try {
              enhanceDiffBlocks();
            } catch (error) {
              console.warn('Failed to decorate diff block', error);
            }
          }
        }
        if (actionPrevButton) {
          actionPrevButton.disabled = applyingSuggestion || actionState.currentIndex === 0;
        }
        if (actionNextButton) {
          actionNextButton.disabled = applyingSuggestion || actionState.currentIndex >= total - 1;
        }
        if (actionSkipButton) {
          actionSkipButton.disabled = applyingSuggestion;
        }
        if (actionApplyButton) {
          if (applyingSuggestion) {
            actionApplyButton.disabled = true;
            actionApplyButton.textContent = 'Applying‚Ä¶';
          } else if (current.status === 'applied') {
            actionApplyButton.disabled = true;
            actionApplyButton.textContent = 'Applied ‚úì';
          } else {
            actionApplyButton.disabled = false;
            actionApplyButton.textContent = 'Apply (A)';
          }
        }
      }

      function setCurrentIndex(index) {
        if (!Number.isInteger(index) || index < 0 || index >= actionState.assessments.length) {
          return;
        }
        actionState.currentIndex = index;
        updateActionView();
      }

      function goNext() {
        if (actionState.currentIndex < actionState.assessments.length - 1) {
          actionState.currentIndex += 1;
          updateActionView();
          return true;
        }
        return false;
      }

      function goPrevious() {
        if (actionState.currentIndex > 0) {
          actionState.currentIndex -= 1;
          updateActionView();
          return true;
        }
        return false;
      }

      async function loadBadAssessments() {
        if (actionState.loading) {
          return;
        }
        actionState.loading = true;
        showActionEmpty('Loading bad assessments‚Ä¶');
        setActionFeedback('info', 'Loading suggestions‚Ä¶');
        try {
          const response = await fetch('/api/assessments/bad', { cache: 'no-store' });
          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            const message = payload && typeof payload.error === 'string'
              ? payload.error
              : `Request failed with status ${response.status}`;
            throw new Error(message);
          }
          const assessments = Array.isArray(payload.assessments) ? payload.assessments : [];
          actionState.assessments = assessments.map((assessment) => ({
            ...assessment,
            status: 'pending'
          }));
          actionState.loaded = true;
          actionState.updatedAt = typeof payload.updatedAt === 'number' ? payload.updatedAt : null;
          if (actionState.assessments.length === 0) {
            setActionFeedback('info', 'No bad assessments were detected in this review.');
            showActionEmpty('No bad assessments were found. Switch back to Report mode to read the full review.');
          } else {
            setActionFeedback('success', `Loaded ${actionState.assessments.length} bad assessment${actionState.assessments.length === 1 ? '' : 's'}.`);
            actionState.currentIndex = 0;
            updateActionView();
          }
        } catch (error) {
          console.error('Failed to load assessments', error);
          setActionFeedback('error', error.message || 'Failed to load bad assessments.');
          showActionEmpty('Could not load bad assessments. Try refreshing the page.');
        } finally {
          actionState.loading = false;
        }
      }

      async function ensureActionData() {
        if (actionState.loaded) {
          if (actionState.assessments.length > 0) {
            updateActionView();
          } else {
            showActionEmpty('No bad assessments were found. Switch back to Report mode to read the full review.');
          }
          return;
        }
        await loadBadAssessments();
      }

      function handleSkip() {
        if (applyingSuggestion || !actionState.assessments.length) {
          return;
        }
        const current = actionState.assessments[actionState.currentIndex];
        markAssessmentStatus(actionState.currentIndex, 'skipped');
        setActionFeedback('info', `Skipped ${current.title || `assessment ${current.id}`}.`);
        if (!goNext()) {
          updateActionView();
        }
      }

      async function handleApply() {
        if (applyingSuggestion || !actionState.assessments.length) {
          return;
        }
        const current = actionState.assessments[actionState.currentIndex];
        if (!current || !current.suggestion || !current.suggestion.diff) {
          setActionFeedback('error', 'No diff suggestion is available for this assessment.');
          return;
        }
        applyingSuggestion = true;
        updateActionView();
        const fileLabel = current.file ? ` for ${current.file}` : '';
        setActionFeedback('info', `Applying suggestion${fileLabel}‚Ä¶`);
        try {
          const response = await fetch(`/api/assessments/${current.id}/apply`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          });
          const payload = await response.json().catch(() => ({}));
          if (!response.ok || payload.success !== true) {
            const message = payload && typeof payload.error === 'string'
              ? payload.error
              : `Apply failed with status ${response.status}`;
            throw new Error(message);
          }
          markAssessmentStatus(actionState.currentIndex, 'applied');
          setActionFeedback('success', `Applied suggestion${fileLabel}.`);
          if (!goNext()) {
            updateActionView();
          }
        } catch (error) {
          console.error('Failed to apply suggestion', error);
          setActionFeedback('error', error.message || 'Failed to apply suggestion.');
          updateActionView();
        } finally {
          applyingSuggestion = false;
          updateActionView();
        }
      }

      function showHelpPanel() {
        if (!actionHelpPanel) {
          return;
        }
        actionHelpPanel.classList.remove('hidden');
        actionHelpPanel.setAttribute('aria-hidden', 'false');
        actionHelpVisible = true;
        actionHelpButton?.setAttribute('aria-expanded', 'true');
        try {
          actionHelpPanel.focus({ preventScroll: true });
        } catch (error) {
          actionHelpPanel.focus();
        }
      }

      function hideHelpPanel() {
        if (!actionHelpPanel) {
          return;
        }
        actionHelpPanel.classList.add('hidden');
        actionHelpPanel.setAttribute('aria-hidden', 'true');
        actionHelpVisible = false;
        actionHelpButton?.setAttribute('aria-expanded', 'false');
      }

      function toggleHelpPanel() {
        if (actionHelpVisible) {
          hideHelpPanel();
        } else {
          showHelpPanel();
        }
      }

      function handleActionHotkeys(event) {
        if (currentViewerMode !== 'action') {
          return;
        }
        if (event.metaKey || event.ctrlKey || event.altKey || event.defaultPrevented) {
          return;
        }
        const target = event.target;
        const tagName = target && target.tagName ? target.tagName.toLowerCase() : '';
        if (tagName === 'input' || tagName === 'textarea' || target?.isContentEditable) {
          return;
        }
        const key = event.key || '';
        if (key === '?') {
          event.preventDefault();
          toggleHelpPanel();
          return;
        }
        if (key === '/' && event.shiftKey) {
          event.preventDefault();
          toggleHelpPanel();
          return;
        }
        const lower = key.toLowerCase();
        if (lower === 'n') {
          event.preventDefault();
          goNext();
        } else if (lower === 'p') {
          event.preventDefault();
          goPrevious();
        } else if (lower === 's') {
          event.preventDefault();
          handleSkip();
        } else if (lower === 'a') {
          event.preventDefault();
          handleApply();
        }
      }

      modeToggleButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const mode = button.dataset.viewerMode === 'action' ? 'action' : 'report';
          setViewerMode(mode);
        });
      });

      actionPrevButton?.addEventListener('click', () => {
        goPrevious();
      });

      actionNextButton?.addEventListener('click', () => {
        goNext();
      });

      actionSkipButton?.addEventListener('click', () => {
        handleSkip();
      });

      actionApplyButton?.addEventListener('click', () => {
        handleApply();
      });

      actionHelpButton?.addEventListener('click', () => {
        toggleHelpPanel();
      });

      actionHelpClose?.addEventListener('click', () => {
        hideHelpPanel();
      });

      document.addEventListener('keydown', handleActionHotkeys);

      setViewerMode(getStoredMode(), { skipStorage: true });

      function applyHighlightTheme(mode) {
        if (!hljsLight || !hljsDark) return;
        if (mode === 'dark') {
          hljsLight.disabled = true;
          hljsDark.disabled = false;
        } else {
          hljsLight.disabled = false;
          hljsDark.disabled = true;
        }
      }

      function setTheme(mode) {
        const root = document.documentElement;
        if (mode === 'dark') {
          root.classList.add('dark');
          themeToggleLabel.textContent = 'Light mode';
          themeToggleIcon.textContent = '‚òÄÔ∏è';
        } else {
          root.classList.remove('dark');
          themeToggleLabel.textContent = 'Dark mode';
          themeToggleIcon.textContent = 'üåô';
        }
        applyHighlightTheme(mode);
      }

      function getPreferredTheme() {
        const stored = window.localStorage.getItem('acr-theme');
        if (stored === 'dark' || stored === 'light') {
          return stored;
        }
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      function toggleTheme() {
        const root = document.documentElement;
        const isDark = root.classList.contains('dark');
        const next = isDark ? 'light' : 'dark';
        window.localStorage.setItem('acr-theme', next);
        setTheme(next);
      }

      setTheme(getPreferredTheme());
      themeToggle?.addEventListener('click', toggleTheme);

      let lastSeenMtime = null;
      let polling = true;

      function formatTimestamp(ms) {
        const date = new Date(ms);
        return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
      }

      async function pollMtime() {
        try {
          const response = await fetch('/mtime', { cache: 'no-store' });
          if (!response.ok) {
            throw new Error(`Request failed with status ${response.status}`);
          }
          const payload = await response.json();
          if (typeof payload.mtimeMs === 'number') {
            if (lastSeenMtime && payload.mtimeMs > lastSeenMtime) {
              window.location.reload();
              return;
            }
            lastSeenMtime = payload.mtimeMs;
            if (statusLine) {
              statusLine.textContent = `Watching‚Ä¶ Last updated ${formatTimestamp(payload.mtimeMs)}`;
              statusLine.classList.remove('text-red-500');
              statusLine.classList.add('text-slate-500', 'dark:text-slate-400');
            }
          }
          polling = true;
        } catch (error) {
          polling = false;
          if (statusLine) {
            statusLine.textContent = 'Disconnected. Retrying‚Ä¶';
            statusLine.classList.remove('text-slate-500', 'dark:text-slate-400');
            statusLine.classList.add('text-red-500');
          }
          console.error('Failed to poll /mtime', error);
        } finally {
          setTimeout(pollMtime, polling ? 2000 : 4000);
        }
      }

      function enhanceDiffBlocks() {
        const blocks = document.querySelectorAll('pre code.language-diff');
        blocks.forEach((block) => {
          if (!block || block.dataset.enhanced === 'true') return;
          if (block.childElementCount > 0) {
            block.dataset.enhanced = 'true';
            return;
          }

          const raw = block.textContent || '';
          const lines = raw.split('\n');
          const fragment = document.createDocumentFragment();

          lines.forEach((line, index) => {
            const isLastLine = index === lines.length - 1;
            if (isLastLine && line === '') {
              return;
            }

            const span = document.createElement('span');
            span.textContent = line;
            span.classList.add('diff-line');

            const startsWith = (prefix) => line.startsWith(prefix);

            if (startsWith('@@')) {
              span.classList.add('diff-hunk');
            } else if (startsWith('+') && !startsWith('+++')) {
              span.classList.add('diff-add');
            } else if (startsWith('-') && !startsWith('---')) {
              span.classList.add('diff-remove');
            } else if (
              startsWith('diff ') ||
              startsWith('index ') ||
              startsWith('---') ||
              startsWith('+++')
            ) {
              span.classList.add('diff-meta');
            } else {
              span.classList.add('diff-context');
            }

            fragment.appendChild(span);
          });

          block.textContent = '';
          block.appendChild(fragment);
          block.dataset.enhanced = 'true';
        });
      }

      try {
        if (window.hljs?.highlightAll) {
          window.hljs.highlightAll();
        } else {
          console.warn('Highlight.js not available; using diff fallback styling.');
        }
      } catch (error) {
        console.error('Failed to apply syntax highlighting', error);
      }

      enhanceDiffBlocks();
      pollMtime();
    </script>
  </body>
</html>
